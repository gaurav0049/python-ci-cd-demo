name: UI Automation Tests

on:
  workflow_dispatch:
    inputs:
      test_folder:
        description: "Enter test folder (e.g. tests/smoke)"
        required: true
        default: tests

      test_marker:
        description: "Enter pytest marker (smoke, regression, sanity)"
        required: false

      environment:
        description: "Select environment"
        required: true
        default: qa
        type: choice
        options:
          - qa
          - staging
          - prod

      browsers:
        description: "Enter browsers (comma separated: chromium,firefox,webkit)"
        required: true
        default: chromium

      parallel:
        description: "Run tests in parallel?"
        required: true
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

jobs:

  # -----------------------------------------
  # Convert browser input to matrix JSON
  # -----------------------------------------
  prepare:
    runs-on: ubuntu-latest
    outputs:
      browser_matrix: ${{ steps.set-matrix.outputs.browser_matrix }}

    steps:
      - name: Convert browsers to JSON array
        id: set-matrix
        run: |
          BROWSERS="${{ github.event.inputs.browsers }}"
          JSON=$(echo $BROWSERS | awk -F',' '{printf "[\"%s\"", $1; for(i=2;i<=NF;i++) printf ",\"%s\"", $i; printf "]"}')
          echo "browser_matrix=$JSON" >> $GITHUB_OUTPUT

  # -----------------------------------------
  # Run tests per browser (parallel matrix)
  # -----------------------------------------
  test:
    needs: prepare
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        browser: ${{ fromJson(needs.prepare.outputs.browser_matrix) }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m playwright install

      - name: Validate Test Folder
        run: |
          if [ ! -d "${{ github.event.inputs.test_folder }}" ]; then
            echo "‚ùå Folder not found!"
            exit 1
          fi

      - name: Run Tests
        run: |
          echo "üìÇ Folder: ${{ github.event.inputs.test_folder }}"
          echo "üè∑ Marker: ${{ github.event.inputs.test_marker }}"
          echo "üåç Environment: ${{ github.event.inputs.environment }}"
          echo "üåê Browser: ${{ matrix.browser }}"
          echo "‚ö° Parallel: ${{ github.event.inputs.parallel }}"

          if [ "${{ github.event.inputs.parallel }}" = "true" ]; then
            PARALLEL_OPTION="-n auto"
          else
            PARALLEL_OPTION=""
          fi

          pytest ${{ github.event.inputs.test_folder }} \
            $PARALLEL_OPTION \
            -m "${{ github.event.inputs.test_marker }}" \
            --ui-browser=${{ matrix.browser }} \
            --html=pytest-report-${{ matrix.browser }}.html \
            --self-contained-html

      - name: Upload HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: pytest-report-${{ matrix.browser }}
          path: pytest-report-${{ matrix.browser }}.html
